# preport - A64FX Performance Report Tool

A command-line tool for analyzing Fujitsu A64FX processor performance profiles generated by the FAPP profiler. It processes PMU (Performance Monitoring Unit) counter data and provides comprehensive performance metrics with bottleneck analysis.

## Features

- **Comprehensive PMU Event Support**: Supports 120+ A64FX PMU events
- **A64FX PMU Errata Corrections**: Applies official corrections for L2 cache miss counting
- **Multiple Output Formats**: ASCII (terminal), HTML (styled report), JSON (programmatic access)
- **Bottleneck Analysis**: Automatic detection of performance issues with optimization suggestions
- **SVE Vectorization Metrics**: Detailed SVE/SIMD utilization analysis

## Requirements

- Node.js (v14 or later)
- FAPP profiler output files (pa1.csv - pa17.csv)

## Installation

```bash
cd preport
# No installation required, run directly with Node.js
```

## Usage

```bash
node preport.js [options]
```

### Options

| Option | Description |
|--------|-------------|
| `-n, --files <num>` | Number of pa*.csv files to read (1-17, default: 17) |
| `-r, --region <name>` | Region to report (can be used multiple times) |
| `--html` | Output HTML format |
| `--json` | Output JSON format |
| `-o, --output <file>` | Output file (default: stdout) |
| `-h, --help` | Show help message |

### Examples

```bash
# ASCII output to terminal (all regions, all counter files)
node preport.js

# Read only first 5 counter files
node preport.js -n 5

# Report specific region only
node preport.js -r dgemm_kernel

# Generate HTML report
node preport.js --html -o report.html

# Generate JSON for programmatic access
node preport.js --json -o report.json

# Combine options
node preport.js -n 17 -r dgemm_kernel --json -o kernel_report.json
```

## Input Files

The tool expects FAPP profiler CSV output files in the current directory:
- `pa1.csv` through `pa17.csv` - Each file contains different sets of PMU counters

These files are generated by running the FAPP profiler with the `-Icpupa` option.

## Output Formats

### ASCII (Default)

Human-readable text format suitable for terminal viewing:

```
================================================================================
                        A64FX Performance Report
================================================================================
Profile Time   : Sat Dec 20 02:45:04 2025
CPU Frequency  : 2200 MHz
Vector Length  : 512 bits

--------------------------------------------------------------------------------
Region: dgemm_kernel
Elapsed Time: 4.277784 s
--------------------------------------------------------------------------------

Core Performance:
  IPC                       :         3.15
  CPI                       :         0.32

Cache Performance:
  L1D Miss Rate             :        11.37 %
  L2 Miss Rate              :         0.70 %
  ...
```

### HTML

Styled HTML report with tables and color-coded bottleneck analysis. Suitable for sharing and archiving.

### JSON

Structured JSON format for programmatic access:

```json
{
  "info": {
    "profilerVersion": "4.2.5",
    "measuredTime": "Sat Dec 20 02:45:04 2025",
    "cpuFrequency": 2200,
    "vectorLength": 512
  },
  "regions": {
    "dgemm_kernel": {
      "elapsed": 4.277784,
      "metrics": { ... },
      "counters": { ... },
      "bottleneckAnalysis": { ... }
    }
  }
}
```

## Metrics Categories

| Category | Metrics |
|----------|---------|
| **Core Performance** | IPC, CPI |
| **Cache Performance** | L1D/L2 miss rates, miss latency |
| **L1 Load-Store Instructions** | Total, single vector loads, broadcast loads, non-SIMD loads/stores |
| **Floating-Point Performance** | GFLOPS (SVE/SIMD/Total), FP operations count |
| **Memory Bandwidth** | Memory read/write bandwidth (GB/s) |
| **Pipeline Utilization** | Stall rates, FLA/FLB/EXA/EXB/EAGA/EAGB utilization |
| **Busy Rate** | Memory, L1, L2 busy rates |
| **Branch Prediction** | Misprediction rate, branch counts |
| **TLB Performance** | L1D/L2D TLB miss rates |
| **Memory Stall Breakdown** | L1/L2 miss stalls, prefetch port stalls |
| **Commit Distribution** | 0/1/2/3/4-instruction commit rates |
| **FP Precision Breakdown** | SP/DP GFLOPS breakdown |
| **SVE/SIMD Operations** | Loads, stores, gather/scatter, prefetch ops |
| **HW Prefetch** | L1/L2 HW prefetch activity |
| **Bus Traffic** | Memory/CMG/Tofu/PCI bandwidth |
| **Energy** | Core/L2/Memory energy, total power |
| **SVE Predication** | Predicate counts, avg active elements |

## Bottleneck Analysis

The tool automatically detects performance bottlenecks and provides optimization suggestions:

### Detected Issues

| Category | Issues Detected |
|----------|-----------------|
| **Core Performance** | Low IPC, high stall rate |
| **Memory** | High memory stall, L2 miss stall, bandwidth saturation |
| **Cache** | High L1D/L2 miss rates |
| **TLB** | High TLB miss rate |
| **Branch** | High branch misprediction |
| **Compute** | High FP/SIMD stall, low FMA utilization |
| **Vectorization** | Low vector utilization, high gather ratio |
| **Frontend** | High ROB empty rate |

### Severity Levels

- **HIGH**: Critical performance issues requiring immediate attention
- **MEDIUM**: Noticeable performance impact
- **LOW**: Minor optimization opportunities
- **INFO**: Informational (e.g., memory-bound workload characteristics)

### Example Analysis Output

```
--------------------------------------------------------------------------------
BOTTLENECK ANALYSIS
--------------------------------------------------------------------------------

[!] Memory: High memory stall rate (25.3%)
    Significant time spent waiting for memory operations.
    Suggestions:
      - Use software prefetching (PRFM instructions)
      - Improve data locality and cache blocking
      - Consider data layout changes for better cache utilization

[*] Cache: High L1D miss rate (22.5%)
    Many memory accesses miss the L1 data cache.
    Suggestions:
      - Improve spatial locality (sequential access patterns)
      - Use smaller data types if precision allows
      - Consider Structure of Arrays (SoA) layout
```

## A64FX PMU Errata Corrections

The tool applies corrections from the A64FX PMU Events Errata document for accurate L2 cache miss counting:

| Event | Correction |
|-------|------------|
| L2D_CACHE_REFILL | raw - L2D_SWAP_DM - L2D_CACHE_MIBMCH_PRF |
| L2D_CACHE_REFILL_DM | raw - L2D_SWAP_DM |
| L2D_CACHE_REFILL_PRF | raw - L2D_CACHE_MIBMCH_PRF |
| L2_MISS_COUNT | raw - L2D_CACHE_SWAP_LOCAL - L2_PIPE_COMP_PF_L2MIB_MCH |

These corrections account for overcounting that occurs when demand and prefetch requests are temporally close.

## License

See [LICENSE](LICENSE) file.
